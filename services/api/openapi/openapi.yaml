openapi: 3.0.3

info:
  title: Kids Planet Game Portal API
  version: 0.2.0
  description: |
    API for Kids Planet educational HTML5 game portal (Player + Admin).
    Served behind Nginx reverse proxy where /api/* is forwarded to the Go API root,
    and game assets are served under /games/*.

servers:
  - url: /api
    description: Behind Nginx reverse proxy

tags:
  - name: System
    description: System health and liveness
  - name: Public Games
    description: Public catalog and game detail
  - name: Public Categories
    description: Public category listing
  - name: Sessions
    description: Gameplay session lifecycle
  - name: Analytics
    description: Gameplay analytics ingestion
  - name: Leaderboard
    description: Leaderboard submit and read APIs
  - name: Player Auth
    description: Optional player account authentication
  - name: Player History
    description: Player gameplay history
  - name: Admin Auth
    description: Admin authentication endpoints
  - name: Admin Profile
    description: Admin identity endpoints
  - name: Admin Dashboard
    description: Admin dashboard metrics
  - name: Admin Games
    description: Admin game management and ZIP upload
  - name: Admin Categories
    description: Admin age and education category management

paths:
  /health:
    get:
      tags: [System]
      summary: Health check
      description: |
        Liveness endpoint. In non-prod, you can simulate an error via `?fail=1`.
      parameters:
        - in: query
          name: fail
          required: false
          schema:
            type: string
            example: "1"
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              examples:
                ok:
                  value:
                    data:
                      ok: true
                      service: api
                      env: dev
                      time: "2026-01-17T04:09:24Z"
        "400":
          $ref: "#/components/responses/BadRequest"

  /games:
    get:
      tags: [Public Games]
      summary: List active games
      description: |
        Public catalog listing with filter and sort.
      parameters:
        - in: query
          name: age_category_id
          required: false
          schema:
            type: integer
            format: int64
            minimum: 1
        - in: query
          name: education_category_id
          required: false
          schema:
            type: integer
            format: int64
            minimum: 1
        - in: query
          name: sort
          required: false
          schema:
            type: string
            enum: [newest, popular]
            default: newest
        - in: query
          name: page
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 24
      responses:
        "200":
          description: Game list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GameListResponse"
              examples:
                game_list:
                  value:
                    data:
                      items:
                        - id: 1
                          title: "Color Match"
                          slug: "color-match"
                          thumbnail: null
                          game_url: "/games/1/current/index.html"
                          age_category_id: 1
                          age_label: "7+"
                          min_age: 7
                          max_age: 10
                          education_category_ids: [1, 2]
                          education_categories:
                            - id: 1
                              name: "Math"
                            - id: 2
                              name: "Logic"
                          play_count: 123
                          free: true
                          created_at: "2026-01-10T09:00:00Z"
                      page: 1
                      limit: 24
                      total: 1
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /games/{id}:
    get:
      tags: [Public Games]
      summary: Get active game detail
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      responses:
        "200":
          description: Game detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GameDetailResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /categories:
    get:
      tags: [Public Categories]
      summary: List public categories
      parameters:
        - in: query
          name: type
          required: false
          schema:
            type: string
            enum: [age, education]
      responses:
        "200":
          description: Category list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PublicCategoriesResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /sessions/start:
    post:
      tags: [Sessions]
      summary: Start play session
      description: |
        Creates a short-lived `play_token`. Endpoint is public, but optionally accepts
        player JWT in Authorization header to bind player identity into token subject.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SessionStartRequest"
      responses:
        "200":
          description: Session started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionStartResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /analytics/event:
    post:
      tags: [Analytics]
      summary: Track gameplay analytics event
      description: |
        Ingests gameplay event with `play_token` in request body.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AnalyticsEventRequest"
            examples:
              analytics_event:
                value:
                  play_token: "<play_token>"
                  name: "game_start"
                  data:
                    level: 1
                    source: "sdk"
      responses:
        "200":
          description: Event accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnalyticsEventResponse"
              examples:
                accepted:
                  value:
                    data:
                      ok: true
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/InternalError"

  /leaderboard/submit:
    post:
      tags: [Leaderboard]
      summary: Submit score
      description: |
        Submit score using play token (Authorization header).
        Requires `X-Guest-Id` when no player subject is present.
      security:
        - PlayTokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LeaderboardSubmitRequest"
      responses:
        "200":
          description: Submission accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LeaderboardSubmitResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/InternalError"

  /leaderboard/{game_id}:
    get:
      tags: [Leaderboard]
      summary: Read leaderboard top entries
      parameters:
        - in: path
          name: game_id
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
        - in: query
          name: period
          required: false
          schema:
            type: string
            enum: [daily, weekly]
            default: daily
        - in: query
          name: scope
          required: false
          schema:
            type: string
            enum: [game, global]
            default: game
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
      responses:
        "200":
          description: Leaderboard data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LeaderboardResponse"
              examples:
                leaderboard_top:
                  value:
                    data:
                      game_id: 1
                      period: daily
                      scope: game
                      limit: 10
                      items:
                        - member: "g:guest_001"
                          score: 1200
                        - member: "s:2b67..."
                          score: 1100
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /leaderboard/{game_id}/self:
    get:
      tags: [Leaderboard]
      summary: Read caller rank and score
      description: |
        Authorization supports either player JWT or play token.
      security:
        - BearerAuth: []
        - PlayTokenAuth: []
      parameters:
        - in: path
          name: game_id
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
        - in: query
          name: period
          required: false
          schema:
            type: string
            enum: [daily, weekly]
            default: daily
        - in: query
          name: scope
          required: false
          schema:
            type: string
            enum: [game, global]
            default: game
      responses:
        "200":
          description: Self leaderboard view
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LeaderboardSelfResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/player/register:
    post:
      tags: [Player Auth]
      summary: Register player
      description: |
        Creates optional player account with email + 6-digit PIN.
        Note: response is legacy top-level payload (no `{ data: ... }` wrapper).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PlayerAuthRequest"
      responses:
        "200":
          description: Player registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PlayerAuthResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/player/login:
    post:
      tags: [Player Auth]
      summary: Login player
      description: |
        Authenticates player using email + 6-digit PIN.
        Note: response is legacy top-level payload (no `{ data: ... }` wrapper).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PlayerAuthRequest"
      responses:
        "200":
          description: Player authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PlayerAuthResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/player/logout:
    post:
      tags: [Player Auth]
      summary: Logout player
      description: Stateless logout endpoint.
      responses:
        "204":
          description: Logged out

  /player/history:
    get:
      tags: [Player History]
      summary: List player gameplay history
      description: |
        Requires player JWT in Authorization header.
        Note: response is top-level `{ data, pagination }`.
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: page
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
      responses:
        "200":
          description: Player history
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PlayerHistoryResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/admin/login:
    post:
      tags: [Admin Auth]
      summary: Admin login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminLoginRequest"
      responses:
        "200":
          description: Admin token issued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminLoginResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /admin/ping:
    get:
      tags: [Admin Profile]
      summary: Admin auth ping
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Authorized and active
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminPingResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /admin/me:
    get:
      tags: [Admin Profile]
      summary: Get current admin
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Admin profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminMeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /admin/dashboard/overview:
    get:
      tags: [Admin Dashboard]
      summary: Dashboard overview metrics
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Overview metrics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DashboardOverviewResponse"
              examples:
                dashboard_overview:
                  value:
                    data:
                      sessions_today: 89
                      total_active_games: 12
                      total_players: 340
                      top_games:
                        - game_id: 1
                          title: "Color Match"
                          plays: 34
                        - game_id: 2
                          title: "Math Hero"
                          plays: 21
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /admin/games:
    get:
      tags: [Admin Games]
      summary: List games (admin)
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: status
          required: false
          schema:
            type: string
            enum: [draft, active, archived]
        - in: query
          name: q
          required: false
          schema:
            type: string
        - in: query
          name: page
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 24
      responses:
        "200":
          description: Admin game list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminGameListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

    post:
      tags: [Admin Games]
      summary: Create game metadata
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminGameCreateRequest"
      responses:
        "200":
          description: Game created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminGameResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /admin/games/{id}:
    put:
      tags: [Admin Games]
      summary: Update game metadata
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminGameUpdateRequest"
      responses:
        "200":
          description: Game updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminGameResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /admin/games/{id}/publish:
    post:
      tags: [Admin Games]
      summary: Publish game (active)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      responses:
        "200":
          description: Game published
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminGameResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /admin/games/{id}/unpublish:
    post:
      tags: [Admin Games]
      summary: Unpublish game (draft)
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      responses:
        "200":
          description: Game unpublished
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminGameResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /admin/games/{id}/upload:
    post:
      tags: [Admin Games]
      summary: Upload game ZIP package
      description: |
        Upload `.zip` containing web game files.
        Required constraints enforced by backend:
        - root-level `index.html`
        - path safety checks
        - extension allowlist
        - max body size and uncompressed limits
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        "200":
          description: Upload processed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadResponse"
              examples:
                upload_result:
                  value:
                    data:
                      object_key: "1/upload/20260224_120000_a1b2c3d4e5f6a7b8.zip"
                      etag: "1f3870be274f6c49b3e31a0c6728957f"
                      size: 1048576
                      game_url: "/games/1/current/index.html"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "413":
          $ref: "#/components/responses/PayloadTooLarge"
        "422":
          $ref: "#/components/responses/Unprocessable"
        "500":
          $ref: "#/components/responses/InternalError"

  /admin/age-categories:
    get:
      tags: [Admin Categories]
      summary: List age categories
      description: |
        Returns repository wire format objects.
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: q
          required: false
          schema:
            type: string
        - in: query
          name: page
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 24
      responses:
        "200":
          description: Age categories
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminAgeCategoryListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

    post:
      tags: [Admin Categories]
      summary: Create age category
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminAgeCategoryUpdateRequest"
      responses:
        "200":
          description: Age category created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminAgeCategoryResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /admin/age-categories/{id}:
    put:
      tags: [Admin Categories]
      summary: Update age category
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminAgeCategoryRequest"
      responses:
        "200":
          description: Age category updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminAgeCategoryResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      tags: [Admin Categories]
      summary: Delete age category
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      responses:
        "200":
          description: Age category deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /admin/education-categories:
    get:
      tags: [Admin Categories]
      summary: List education categories
      description: |
        Returns repository wire format objects.
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: q
          required: false
          schema:
            type: string
        - in: query
          name: page
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 24
      responses:
        "200":
          description: Education categories
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminEducationCategoryListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

    post:
      tags: [Admin Categories]
      summary: Create education category
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminEducationCategoryUpdateRequest"
      responses:
        "200":
          description: Education category created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminEducationCategoryResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /admin/education-categories/{id}:
    put:
      tags: [Admin Categories]
      summary: Update education category
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminEducationCategoryRequest"
      responses:
        "200":
          description: Education category updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AdminEducationCategoryResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      tags: [Admin Categories]
      summary: Delete education category
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      responses:
        "200":
          description: Education category deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Admin/player JWT bearer token
    PlayTokenAuth:
      type: apiKey
      in: header
      name: Authorization
      description: "Play token. Send as: Bearer <play_token>"

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
          examples:
            bad_request:
              value:
                error:
                  code: BAD_REQUEST
                  message: invalid input
                  request_id: req_a1b2c3

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
          examples:
            unauthorized:
              value:
                error:
                  code: UNAUTHORIZED
                  message: unauthorized
                  request_id: req_a1b2c3

    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
          examples:
            forbidden:
              value:
                error:
                  code: FORBIDDEN
                  message: forbidden
                  request_id: req_a1b2c3

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
          examples:
            not_found:
              value:
                error:
                  code: RESOURCE_NOT_FOUND
                  message: resource not found
                  request_id: req_a1b2c3

    PayloadTooLarge:
      description: Payload too large
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
          examples:
            payload_too_large:
              value:
                error:
                  code: ZIP_TOO_LARGE
                  message: zip too large
                  request_id: req_a1b2c3

    Unprocessable:
      description: Unprocessable entity
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
          examples:
            invalid_zip_path:
              value:
                error:
                  code: INVALID_ZIP_PATH
                  message: zip entry contains invalid path segment
                  request_id: req_a1b2c3

    RateLimited:
      description: Rate limited
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
          examples:
            rate_limited:
              value:
                error:
                  code: RATE_LIMITED
                  message: rate limit exceeded
                  request_id: req_a1b2c3

    InternalError:
      description: Internal error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
          examples:
            internal_error:
              value:
                error:
                  code: INTERNAL_ERROR
                  message: internal error
                  request_id: req_a1b2c3

  schemas:
    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          description: Application error code
          example: BAD_REQUEST
        message:
          type: string
          description: Human-readable message
          example: invalid input
        request_id:
          type: string
          description: Request correlation identifier
          example: req_a1b2c3

    ErrorEnvelope:
      type: object
      required: [error]
      properties:
        error:
          $ref: "#/components/schemas/Error"

    Pagination:
      type: object
      required: [page, limit, total]
      properties:
        page:
          type: integer
          minimum: 1
          example: 1
        limit:
          type: integer
          minimum: 1
          example: 24
        total:
          type: integer
          minimum: 0
          example: 120

    HealthData:
      type: object
      required: [ok, service, time, env]
      properties:
        ok:
          type: boolean
        service:
          type: string
          example: api
        time:
          type: string
          format: date-time
        env:
          type: string
          example: dev

    HealthResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/HealthData"

    PublicEducationCategory:
      type: object
      required: [id, name]
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string

    Category:
      description: Generic category type used across age and education category contexts
      oneOf:
        - $ref: "#/components/schemas/PublicAgeCategory"
        - $ref: "#/components/schemas/PublicEducationCategory"

    Game:
      type: object
      required:
        - id
        - title
        - slug
        - thumbnail
        - game_url
        - age_category_id
        - play_count
        - free
        - created_at
      properties:
        id:
          type: integer
          format: int64
        title:
          type: string
        slug:
          type: string
        thumbnail:
          type: string
          nullable: true
        game_url:
          type: string
          nullable: true
          description: Playable URL usually `/games/{id}/current/index.html`
        age_category_id:
          type: integer
          format: int64
        age_label:
          type: string
          nullable: true
        min_age:
          type: integer
          nullable: true
        max_age:
          type: integer
          nullable: true
        education_category_ids:
          type: array
          items:
            type: integer
            format: int64
        education_categories:
          type: array
          items:
            $ref: "#/components/schemas/PublicEducationCategory"
        play_count:
          type: integer
          format: int64
        free:
          type: boolean
        created_at:
          type: string
          format: date-time

    GameListData:
      type: object
      required: [items, page, limit, total]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Game"
        page:
          type: integer
          minimum: 1
        limit:
          type: integer
          minimum: 1
        total:
          type: integer
          minimum: 0

    GameListResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/GameListData"

    GameDetailResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/Game"

    PublicAgeCategory:
      type: object
      required: [id, label, min_age, max_age]
      properties:
        id:
          type: integer
          format: int64
        label:
          type: string
        min_age:
          type: integer
        max_age:
          type: integer

    PublicCategoriesData:
      type: object
      required: [age_categories, education_categories]
      properties:
        age_categories:
          type: array
          items:
            $ref: "#/components/schemas/PublicAgeCategory"
        education_categories:
          type: array
          items:
            $ref: "#/components/schemas/PublicEducationCategory"

    PublicCategoriesResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/PublicCategoriesData"

    SessionStartRequest:
      type: object
      required: [game_id]
      properties:
        game_id:
          type: integer
          format: int64
          minimum: 1

    Session:
      type: object
      required: [play_token]
      properties:
        play_token:
          type: string
          description: Short-lived gameplay token
        expires_at:
          type: string
          format: date-time

    SessionStartResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/Session"

    AnalyticsEvent:
      type: object
      required: [play_token, name]
      properties:
        play_token:
          type: string
        name:
          type: string
        data:
          description: Optional JSON payload (any valid JSON)
          nullable: true
          oneOf:
            - type: object
              additionalProperties: true
            - type: array
              items: {}
            - type: string
            - type: number
            - type: integer
            - type: boolean

    AnalyticsEventRequest:
      $ref: "#/components/schemas/AnalyticsEvent"

    AnalyticsEventResult:
      type: object
      required: [ok]
      properties:
        ok:
          type: boolean
          example: true

    AnalyticsEventResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/AnalyticsEventResult"

    LeaderboardSubmitRequest:
      type: object
      required: [game_id, score]
      properties:
        game_id:
          type: integer
          format: int64
          minimum: 1
        score:
          type: integer
          minimum: 0

    LeaderboardSubmitResult:
      type: object
      required: [accepted, best_score]
      properties:
        accepted:
          type: boolean
        best_score:
          type: integer

    LeaderboardSubmitResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/LeaderboardSubmitResult"

    LeaderboardEntry:
      type: object
      required: [member, score]
      properties:
        member:
          type: string
          example: "g:guest_001"
        score:
          type: integer

    Leaderboard:
      type: object
      required: [game_id, period, scope, limit, items]
      properties:
        game_id:
          type: integer
          format: int64
        period:
          type: string
          enum: [daily, weekly]
        scope:
          type: string
          enum: [game, global]
        limit:
          type: integer
        items:
          type: array
          items:
            $ref: "#/components/schemas/LeaderboardEntry"

    LeaderboardResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/Leaderboard"

    LeaderboardSelf:
      type: object
      required: [game_id, period, scope]
      properties:
        game_id:
          type: integer
          format: int64
        rank:
          type: integer
          format: int64
          nullable: true
        score:
          type: integer
          format: int64
          nullable: true
        period:
          type: string
          enum: [daily, weekly]
        scope:
          type: string
          enum: [game, global]

    LeaderboardSelfResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/LeaderboardSelf"

    Player:
      type: object
      required: [id, email]
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email

    PlayerAuthRequest:
      type: object
      required: [email, pin]
      properties:
        email:
          type: string
          format: email
        pin:
          type: string
          pattern: "^[0-9]{6}$"
          description: 6-digit parent PIN

    PlayerAuthResponse:
      type: object
      required: [token, player]
      properties:
        token:
          type: string
        player:
          $ref: "#/components/schemas/Player"

    PlayerHistoryItem:
      type: object
      required: [game_id, title, played_at]
      properties:
        game_id:
          type: integer
          format: int64
        title:
          type: string
        played_at:
          type: string
          format: date-time
        score:
          type: integer
          nullable: true
        status:
          type: string
          nullable: true

    PlayerHistoryResponse:
      type: object
      required: [data, pagination]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/PlayerHistoryItem"
        pagination:
          type: object
          required: [page, limit, total]
          properties:
            page:
              type: integer
            limit:
              type: integer
            total:
              type: integer

    AdminLoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    AdminLoginData:
      type: object
      required: [access_token, expires_in]
      properties:
        access_token:
          type: string
        expires_in:
          type: integer
          format: int64
          description: Token lifetime in seconds

    AdminLoginResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/AdminLoginData"

    AdminPingData:
      type: object
      required: [ok]
      properties:
        ok:
          type: boolean

    AdminPingResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/AdminPingData"

    AdminMe:
      type: object
      required: [id, email, role]
      properties:
        id:
          type: integer
          format: int64
        email:
          type: string
          format: email
        role:
          type: string
          enum: [admin]

    AdminMeResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/AdminMe"

    DashboardTopGame:
      type: object
      required: [game_id, title, plays]
      properties:
        game_id:
          type: integer
          format: int64
        title:
          type: string
        plays:
          type: integer

    DashboardOverview:
      type: object
      required: [sessions_today, top_games, total_active_games, total_players]
      properties:
        sessions_today:
          type: integer
        top_games:
          type: array
          items:
            $ref: "#/components/schemas/DashboardTopGame"
        total_active_games:
          type: integer
        total_players:
          type: integer

    DashboardOverviewResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/DashboardOverview"

    AdminEducationCategory:
      type: object
      required: [id, name]
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string

    AdminGame:
      type: object
      required:
        - id
        - title
        - slug
        - status
        - age_category_id
        - free
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          format: int64
        title:
          type: string
        slug:
          type: string
        status:
          type: string
          enum: [draft, active, archived]
        thumbnail:
          type: string
        game_url:
          type: string
        age_category_id:
          type: integer
          format: int64
        education_category_ids:
          type: array
          items:
            type: integer
            format: int64
        education_categories:
          type: array
          items:
            $ref: "#/components/schemas/AdminEducationCategory"
        free:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    AdminGameListData:
      type: object
      required: [items, page, limit, total]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/AdminGame"
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer

    AdminGameListResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/AdminGameListData"

    AdminGameResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/AdminGame"

    AdminGameCreateRequest:
      type: object
      required: [title, slug, age_category_id]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 150
        slug:
          type: string
          minLength: 1
          maxLength: 150
          description: Lowercase and dash-separated
        age_category_id:
          type: integer
          format: int64
          minimum: 1
        education_category_ids:
          type: array
          items:
            type: integer
            format: int64
            minimum: 1
        thumbnail:
          type: string
        game_url:
          type: string
        free:
          type: boolean

    AdminGameUpdateRequest:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 150
        slug:
          type: string
          minLength: 1
          maxLength: 150
        age_category_id:
          type: integer
          format: int64
          minimum: 1
        education_category_ids:
          type: array
          items:
            type: integer
            format: int64
            minimum: 1
        thumbnail:
          type: string
          nullable: true
        game_url:
          type: string
          nullable: true
        free:
          type: boolean

    UploadResult:
      type: object
      required: [object_key, etag, size, game_url]
      properties:
        object_key:
          type: string
        etag:
          type: string
        size:
          type: integer
          format: int64
        game_url:
          type: string
          example: "/games/1/current/index.html"

    UploadResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/UploadResult"

    AdminAgeCategoryRequest:
      type: object
      required: [label, min_age, max_age]
      properties:
        label:
          type: string
        min_age:
          type: integer
          minimum: 0
        max_age:
          type: integer
          minimum: 0

    AdminAgeCategoryUpdateRequest:
      type: object
      properties:
        label:
          type: string
        min_age:
          type: integer
          minimum: 0
        max_age:
          type: integer
          minimum: 0

    AdminAgeCategoryWire:
      type: object
      required: [ID, Label, MinAge, MaxAge, CreatedAt]
      properties:
        ID:
          type: integer
          format: int64
        Label:
          type: string
        MinAge:
          type: integer
        MaxAge:
          type: integer
        CreatedAt:
          type: string
          format: date-time

    AdminAgeCategoryListData:
      type: object
      required: [items, page, limit]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/AdminAgeCategoryWire"
        page:
          type: integer
        limit:
          type: integer

    AdminAgeCategoryListResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/AdminAgeCategoryListData"

    AdminAgeCategoryResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/AdminAgeCategoryWire"

    SQLNullString:
      type: object
      required: [String, Valid]
      properties:
        String:
          type: string
        Valid:
          type: boolean

    AdminEducationCategoryRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        icon:
          type: string
          nullable: true
        color:
          type: string
          nullable: true
          example: "#00AEEF"

    AdminEducationCategoryUpdateRequest:
      type: object
      properties:
        name:
          type: string
        icon:
          type: string
          nullable: true
        color:
          type: string
          nullable: true
          example: "#00AEEF"

    AdminEducationCategoryWire:
      type: object
      required: [ID, Name, Icon, Color, CreatedAt]
      properties:
        ID:
          type: integer
          format: int64
        Name:
          type: string
        Icon:
          $ref: "#/components/schemas/SQLNullString"
        Color:
          $ref: "#/components/schemas/SQLNullString"
        CreatedAt:
          type: string
          format: date-time

    AdminEducationCategoryListData:
      type: object
      required: [items, page, limit]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/AdminEducationCategoryWire"
        page:
          type: integer
        limit:
          type: integer

    AdminEducationCategoryListResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/AdminEducationCategoryListData"

    AdminEducationCategoryResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/AdminEducationCategoryWire"

    DeleteResult:
      type: object
      required: [deleted]
      properties:
        deleted:
          type: boolean
          enum: [true]

    DeleteResponse:
      type: object
      required: [data]
      properties:
        data:
          $ref: "#/components/schemas/DeleteResult"
