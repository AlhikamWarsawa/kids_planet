openapi: 3.0.3

info:
  title: Kids Planet Game Portal API
  version: 0.2.0
  description: |
    API for Kids Planet educational HTML5 game portal (Player + Admin + Game SDK).
    Served behind Nginx reverse proxy where /api/* is forwarded to the Go API root.

servers:
  - url: /api
    description: Behind Nginx reverse proxy

tags:
  - name: System
  - name: Auth
  - name: Sessions
  - name: Games
  - name: Leaderboard
  - name: Achievements
  - name: Analytics
  - name: Admin Dashboard
  - name: Admin Games
  - name: Admin Categories
  - name: Admin Achievements
  - name: Admin Moderation

paths:
  /health:
    get:
      tags: [System]
      summary: Health check
      description: |
        Liveness endpoint. In non-prod, you can simulate an error via ?fail=1.
      parameters:
        - in: query
          name: fail
          schema: { type: string, example: "1" }
          required: false
          description: Non-prod only. When set to "1", returns BAD_REQUEST (simulated).
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SuccessResponse" }
              examples:
                ok:
                  value:
                    data:
                      ok: true
                      service: api
                      env: dev
                      time: "2026-01-17T04:09:24Z"
        "400":
          description: Simulated error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /games:
    get:
      tags: [Games]
      summary: List games for catalog (grid)
      description: |
        Public endpoint for catalog listing with filter & sort.
        Returns only active games.
        Note: sort=popular is accepted as placeholder and currently falls back to newest.
      parameters:
        - in: query
          name: age_category_id
          schema: { type: integer, format: int64, minimum: 1 }
          required: false
        - in: query
          name: education_category_id
          schema: { type: integer, format: int64, minimum: 1 }
          required: false
        - in: query
          name: sort
          schema:
            type: string
            enum: [newest, popular]
            default: newest
          required: false
          description: popular accepted as placeholder (falls back to newest for now).
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
          required: false
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100, default: 24 }
          required: false
      responses:
        "200":
          description: List of games
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/GameListData" }
        "400":
          description: Invalid filter or pagination
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /games/{id}:
    get:
      tags: [Games]
      summary: Get game detail (public)
      description: |
        Returns game detail needed by play page.
        Only returns active games for public access.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64, minimum: 1 }
      responses:
        "200":
          description: Game detail
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/GameDetail" }
        "400":
          description: Invalid id
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Game not found (or not active)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /auth/admin/login:
    post:
      tags: [Auth]
      summary: Admin login
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/LoginRequest" }
      responses:
        "200":
          description: Admin access token
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/AuthToken" }
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /auth/player/login:
    post:
      tags: [Auth]
      summary: Player login (optional)
      description: Email + parent PIN (lightweight).
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/PlayerLoginRequest" }
      responses:
        "200":
          description: Player access token
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/AuthToken" }
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /auth/player/register:
    post:
      tags: [Auth]
      summary: Player register (optional)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/PlayerRegisterRequest" }
      responses:
        "200":
          description: Player created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SuccessResponse" }
        "400":
          description: Invalid input
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "409":
          description: Email already exists
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /admin/me:
    get:
      tags: [Auth]
      summary: Get current admin (token check)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Current admin
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/AdminMe" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /sessions/start:
    post:
      tags: [Sessions]
      summary: Start play session (guest or logged-in)
      description: Returns short-lived play_token for submitting score/events.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/SessionStartRequest" }
      responses:
        "200":
          description: Play token created
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/PlaySession" }
        "400":
          description: Invalid request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Game not found or not playable
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /leaderboard/submit:
    post:
      tags: [Leaderboard]
      summary: Submit score
      description: |
        Called by HTML5 game via SDK. Requires play_token.
        Server may flag suspicious submissions.
      security:
        - playTokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/LeaderboardSubmitRequest" }
      responses:
        "200":
          description: Submission accepted
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/LeaderboardSubmitResult" }
              examples:
                accepted:
                  value:
                    data:
                      accepted: true
                      flagged: false
                      flag_reason: null
                      best_score: 100
        "400":
          description: Invalid score payload
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Missing/invalid play token
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Token game mismatch / forbidden
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "429":
          description: Rate limited
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /leaderboard/{game_id}:
    get:
      tags: [Leaderboard]
      summary: Read leaderboard top N (game or global)
      description: |
        Reads leaderboard from Valkey ZSET for current day/week.
        If key doesn't exist yet, returns items: [].
      parameters:
        - in: path
          name: game_id
          required: true
          schema: { type: integer, format: int64, minimum: 1 }
          description: Game id used when scope=game. For scope=global it's still required by route (kept for compatibility).
        - in: query
          name: period
          required: false
          schema:
            type: string
            enum: [daily, weekly]
            default: daily
          description: Leaderboard time window.
        - in: query
          name: scope
          required: false
          schema:
            type: string
            enum: [game, global]
            default: game
          description: game = per game leaderboard; global = cross-game leaderboard (may be empty if not populated yet).
        - in: query
          name: limit
          required: false
          schema: { type: integer, minimum: 1, maximum: 100, default: 10 }
          description: Top N entries.
      responses:
        "200":
          description: Leaderboard view
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/LeaderboardViewResponse" }
              examples:
                ok_game_daily:
                  value:
                    data:
                      game_id: 1
                      period: daily
                      scope: game
                      limit: 10
                      items:
                        - member: "g:jb_guest_001"
                          score: 100
                        - member: "g:jb_guest_002"
                          score: 80
                ok_global_weekly_empty:
                  value:
                    data:
                      game_id: 1
                      period: weekly
                      scope: global
                      limit: 10
                      items: []
        "400":
          description: Invalid query or params
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /achievement/unlock:
    post:
      tags: [Achievements]
      summary: Unlock achievement event (from game)
      description: Called by HTML5 game. Requires play_token.
      security:
        - playTokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AchievementUnlockRequest" }
      responses:
        "200":
          description: Unlock accepted
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SuccessResponse" }
        "400":
          description: Invalid payload
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Invalid play token
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /achievement/player/{player_id}:
    get:
      tags: [Achievements]
      summary: List player achievements (optional player account)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: player_id
          required: true
          schema: { type: integer, format: int64 }
      responses:
        "200":
          description: Player achievements
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data:
                        type: array
                        items: { $ref: "#/components/schemas/PlayerAchievement" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /analytics/event:
    post:
      tags: [Analytics]
      summary: Track analytics event (from game)
      description: Called by HTML5 game. Requires play_token in request body.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AnalyticsEventRequest" }
      responses:
        "200":
          description: Event accepted
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SuccessResponse" }
        "400":
          description: Invalid event payload
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Invalid play token
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Play session not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "429":
          description: Rate limited
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Internal error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /admin/dashboard/overview:
    get:
      tags: [Admin Dashboard]
      summary: Admin dashboard overview
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Overview stats
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/AdminOverview" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /admin/games:
    get:
      tags: [Admin Games]
      summary: List games (admin)
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: status
          required: false
          schema:
            type: string
            enum: [draft, active, archived]
          description: Optional status filter.
        - in: query
          name: q
          required: false
          schema: { type: string, example: "color" }
          description: Search by title or slug (ILIKE).
        - in: query
          name: page
          required: false
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: limit
          required: false
          schema: { type: integer, minimum: 1, maximum: 100, default: 24 }
      responses:
        "200":
          description: Admin game list
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/AdminGameListData" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    post:
      tags: [Admin Games]
      summary: Create game metadata (draft)
      description: |
        Creates a new game as draft. Publish via /admin/games/{id}/publish.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AdminGameCreateRequest" }
      responses:
        "200":
          description: Created (draft)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/AdminGameDTO" }
        "400":
          description: Invalid input / slug conflict / bad age_category_id
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "409":
          description: Slug already exists
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /admin/games/{id}:
    put:
      tags: [Admin Games]
      summary: Update game metadata
      description: |
        Updates metadata fields only. Publishing is done via /publish.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64, minimum: 1 }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AdminGameUpdateRequest" }
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/AdminGameDTO" }
        "400":
          description: Invalid input / slug conflict / bad age_category_id
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Game not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "409":
          description: Slug already exists
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /admin/games/{id}/upload:
    post:
      tags: [ Admin Games ]
      summary: Upload game ZIP package
      description: |
        Upload HTML5 game package as ZIP file.
        The ZIP will be stored in MinIO and later served via game_url.
        - Only .zip files are allowed
        - Max size is limited by server configuration
      security:
        - bearerAuth: [ ]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
          description: Game ID to attach the uploaded ZIP to
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [ file ]
              properties:
                file:
                  type: string
                  format: binary
                  description: ZIP file containing the HTML5 game
      responses:
        "200":
          description: Upload successful
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/AdminGameUploadResult"
              examples:
                ok:
                  value:
                    data:
                      game_id: 7
                      object_key: games/7/game.zip
                      etag: "a1b2c3d4e5f6"
                      filename: my_game.zip
        "400":
          description: |
            Bad request:
            - file missing
            - invalid file type (not zip)
            - file too large
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Missing or invalid token
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Game not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "413":
          description: Payload too large
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /admin/games/{id}/publish:
    post:
      tags: [Admin Games]
      summary: Publish game (set status active)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64, minimum: 1 }
      responses:
        "200":
          description: Published
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/AdminGameDTO" }
        "400":
          description: Invalid id
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Game not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /admin/games/{id}/unpublish:
    post:
      tags: [Admin Games]
      summary: Unpublish game (set status draft)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64, minimum: 1 }
      responses:
        "200":
          description: Unpublished
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/AdminGameDTO" }
        "400":
          description: Invalid id
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Game not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /admin/education-categories:
    get:
      tags: [Admin Categories]
      summary: List education categories (admin)
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: q
          required: false
          schema: { type: string, example: "math" }
          description: Search by name (ILIKE).
        - in: query
          name: page
          required: false
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: limit
          required: false
          schema: { type: integer, minimum: 1, maximum: 100, default: 24 }
      responses:
        "200":
          description: Education categories
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/AdminEducationCategoryListData" }
        "400":
          description: Invalid query/pagination
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    post:
      tags: [Admin Categories]
      summary: Create education category (admin)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AdminEducationCategoryCreateRequest" }
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/AdminEducationCategoryDTO" }
        "400":
          description: Invalid input / duplicate name
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "409":
          description: Duplicate (unique constraint)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /admin/education-categories/{id}:
    put:
      tags: [Admin Categories]
      summary: Update education category (admin)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64, minimum: 1 }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AdminEducationCategoryUpdateRequest" }
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/AdminEducationCategoryDTO" }
        "400":
          description: Invalid input / duplicate name
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "409":
          description: Duplicate (unique constraint)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    delete:
      tags: [Admin Categories]
      summary: Delete education category (admin)
      description: |
        Deletes a category. If referenced by game_education_categories, DB FK may reject delete.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64, minimum: 1 }
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SuccessResponse" }
              examples:
                ok:
                  value:
                    data:
                      deleted: true
                      id: 1
        "400":
          description: Invalid id / cannot delete due to FK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /admin/age-categories:
    get:
      tags: [Admin Categories]
      summary: List age categories (admin)
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: q
          required: false
          schema: { type: string, example: "7+" }
          description: Search by label (ILIKE).
        - in: query
          name: page
          required: false
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: limit
          required: false
          schema: { type: integer, minimum: 1, maximum: 100, default: 24 }
      responses:
        "200":
          description: Age categories
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/AdminAgeCategoryListData" }
        "400":
          description: Invalid query/pagination
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    post:
      tags: [Admin Categories]
      summary: Create age category (admin)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AdminAgeCategoryCreateRequest" }
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/AdminAgeCategoryDTO" }
        "400":
          description: Invalid input / duplicate label / invalid range
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "409":
          description: Duplicate (unique constraint)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /admin/age-categories/{id}:
    put:
      tags: [Admin Categories]
      summary: Update age category (admin)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64, minimum: 1 }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AdminAgeCategoryUpdateRequest" }
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessResponse"
                  - type: object
                    properties:
                      data: { $ref: "#/components/schemas/AdminAgeCategoryDTO" }
        "400":
          description: Invalid input / duplicate label / invalid range
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "409":
          description: Duplicate (unique constraint)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    delete:
      tags: [Admin Categories]
      summary: Delete age category (admin)
      description: |
        Deletes an age category. If referenced by games.age_category_id, DB FK will reject delete.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64, minimum: 1 }
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SuccessResponse" }
              examples:
                ok:
                  value:
                    data:
                      deleted: true
                      id: 1
        "400":
          description: Invalid id / cannot delete due to FK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /admin/achievements:
    get:
      tags: [Admin Achievements]
      summary: List achievements (stub)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Achievements list
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SuccessResponse" }
        "501":
          description: Not implemented
    post:
      tags: [Admin Achievements]
      summary: Create achievement (stub)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AdminAchievementUpsertRequest" }
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SuccessResponse" }
        "501":
          description: Not implemented

  /admin/moderation/flagged:
    get:
      tags: [Admin Moderation]
      summary: List flagged leaderboard submissions
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Flagged submissions
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SuccessResponse" }

  /admin/moderation/remove-score:
    post:
      tags: [Admin Moderation]
      summary: Remove a score from leaderboard (moderation)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ModerationRemoveScoreRequest" }
      responses:
        "200":
          description: Removed
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SuccessResponse" }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Admin/Player access token
    playTokenAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Short-lived play token for game iframe submissions (score/events)

  schemas:
    SuccessResponse:
      type: object
      properties:
        data: { nullable: true }

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
              example: BAD_REQUEST
            message:
              type: string
              example: invalid input

    Paging:
      type: object
      properties:
        limit: { type: integer, example: 24 }
        offset: { type: integer, example: 0 }

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string, format: password }

    PlayerLoginRequest:
      type: object
      required: [email, parent_pin]
      properties:
        email: { type: string, format: email }
        parent_pin: { type: string, minLength: 4, maxLength: 12 }

    PlayerRegisterRequest:
      type: object
      required: [email, parent_pin, nickname]
      properties:
        email: { type: string, format: email }
        parent_pin: { type: string, minLength: 4, maxLength: 12 }
        nickname: { type: string, minLength: 2, maxLength: 50 }
        age: { type: integer, minimum: 1, maximum: 99 }

    AuthToken:
      type: object
      properties:
        access_token: { type: string }
        token_type: { type: string, example: Bearer }
        expires_in: { type: integer, example: 604800 }

    SessionStartRequest:
      type: object
      required: [game_id]
      properties:
        game_id: { type: integer, format: int64 }
        mode:
          type: string
          enum: [guest, player]
          default: guest
        client:
          type: object
          properties:
            user_agent: { type: string }
            ip: { type: string }

    PlaySession:
      type: object
      properties:
        session_id: { type: string, example: "sess_01J..." }
        game_id: { type: integer, format: int64 }
        play_token: { type: string, description: Short-lived token for score/events }
        expires_in: { type: integer, example: 7200 }

    EducationCategory:
      type: object
      properties:
        id: { type: integer, format: int64 }
        name: { type: string }
        icon: { type: string, nullable: true }
        color: { type: string, nullable: true }

    AgeCategory:
      type: object
      properties:
        id: { type: integer, format: int64 }
        label: { type: string, example: "7+" }
        min_age: { type: integer, example: 7 }
        max_age: { type: integer, example: 10 }
      required: [id, label, min_age, max_age]

    GameCard:
      type: object
      properties:
        id: { type: integer, format: int64 }
        title: { type: string }
        thumbnail: { type: string }
        min_age_label: { type: string, example: "7+" }
        difficulty: { type: string, nullable: true, example: easy }
        free: { type: boolean, example: true }
        education_categories:
          type: array
          items: { $ref: "#/components/schemas/EducationCategory" }
        popularity_score:
          type: integer
          description: Simple popularity metric (e.g., last 7d plays)
          example: 123

    LeaderboardSubmitRequest:
      type: object
      required: [game_id, score, timestamp]
      properties:
        game_id: { type: integer, format: int64 }
        score: { type: integer, minimum: 0 }
        timestamp: { type: string, format: date-time }
        meta:
          type: object
          properties:
            level: { type: string }
            duration_sec: { type: integer, minimum: 0 }

    LeaderboardSubmitResult:
      type: object
      properties:
        accepted: { type: boolean, example: true }
        flagged: { type: boolean, example: false }
        flag_reason: { type: string, nullable: true }
        best_score:
          type: integer
          description: Best score stored for this user/session in the period
          example: 1200

    LeaderboardItem:
      type: object
      required: [member, score]
      properties:
        member: { type: string, example: "g:jb_guest_001" }
        score: { type: integer, example: 100 }

    LeaderboardViewResponse:
      type: object
      required: [game_id, period, scope, limit, items]
      properties:
        game_id: { type: integer, format: int64, example: 1 }
        period: { type: string, enum: [daily, weekly], example: daily }
        scope: { type: string, enum: [game, global], example: game }
        limit: { type: integer, example: 10 }
        items:
          type: array
          items: { $ref: "#/components/schemas/LeaderboardItem" }

    LeaderboardEntry:
      type: object
      properties:
        rank: { type: integer, example: 1 }
        member: { type: string, example: "p:123" }
        score: { type: integer, example: 9999 }

    LeaderboardResponse:
      type: object
      properties:
        game_id: { type: integer, format: int64 }
        period: { type: string, example: weekly }
        items:
          type: array
          items: { $ref: "#/components/schemas/LeaderboardEntry" }

    AchievementUnlockRequest:
      type: object
      required: [game_id, achievement_id, timestamp]
      properties:
        game_id: { type: integer, format: int64 }
        achievement_id: { type: integer, format: int64 }
        timestamp: { type: string, format: date-time }
        condition:
          type: object
          description: Optional debug payload from game
          properties:
            score: { type: integer }
            plays: { type: integer }
            time_spent_sec: { type: integer }

    PlayerAchievement:
      type: object
      properties:
        achievement_id: { type: integer, format: int64 }
        game_id: { type: integer, format: int64 }
        unlocked_at: { type: string, format: date-time }
        reward:
          type: object
          properties:
            badge: { type: string }
            points: { type: integer }

    AnalyticsEventRequest:
      type: object
      required: [play_token, name]
      properties:
        play_token: { type: string, description: Short-lived token from /sessions/start }
        name: { type: string, description: Event name (e.g. level_start) }
        data:
          type: object
          additionalProperties: true
          nullable: true
          description: Optional event payload (kept flexible for MVP)

    AdminOverview:
      type: object
      properties:
        total_active_games: { type: integer, example: 12 }
        total_players: { type: integer, example: 340 }
        sessions_today: { type: integer, example: 89 }
        top_games:
          type: array
          items:
            type: object
            properties:
              game_id: { type: integer, format: int64 }
              title: { type: string }
              plays: { type: integer }

    AdminGameDTO:
      type: object
      required: [id, title, slug, status, age_category_id, free, created_at, updated_at]
      properties:
        id: { type: integer, format: int64 }
        title: { type: string }
        slug: { type: string }
        status:
          type: string
          enum: [draft, active, archived]
        thumbnail: { type: string, nullable: true }
        game_url: { type: string, nullable: true }
        age_category_id: { type: integer, format: int64 }
        free: { type: boolean }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    AdminGameListData:
      type: object
      required: [items, page, limit, total]
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/AdminGameDTO" }
        page: { type: integer, example: 1 }
        limit: { type: integer, example: 24 }
        total: { type: integer, example: 1 }

    AdminGameCreateRequest:
      type: object
      required: [title, slug, age_category_id]
      properties:
        title: { type: string, minLength: 1, maxLength: 150 }
        slug:
          type: string
          minLength: 1
          maxLength: 150
          description: Lowercase + dash recommended (validated by server).
        age_category_id: { type: integer, format: int64, minimum: 1 }
        thumbnail: { type: string, nullable: true }
        game_url:
          type: string
          nullable: true
          description: Usually null at create; will be set after upload flow later.
        free:
          type: boolean
          default: true

    AdminGameUpdateRequest:
      type: object
      description: Partial update. Only provided fields are updated.
      properties:
        title: { type: string, minLength: 1, maxLength: 150 }
        slug:
          type: string
          minLength: 1
          maxLength: 150
          description: Lowercase + dash recommended (validated by server).
        age_category_id: { type: integer, format: int64, minimum: 1 }
        thumbnail: { type: string, nullable: true }
        game_url: { type: string, nullable: true }
        free: { type: boolean }

    AdminGameUpsertRequest:
      type: object
      required: [title, age_category_id, education_category_ids, free, status]
      properties:
        title: { type: string }
        slug: { type: string }
        description: { type: string }
        thumbnail: { type: string }
        age_category_id: { type: integer, format: int64 }
        education_category_ids:
          type: array
          items: { type: integer, format: int64 }
        difficulty:
          type: string
          nullable: true
          description: Optional difficulty label
        free: { type: boolean }
        status:
          type: string
          enum: [draft, active, archived]

    AdminEducationCategoryDTO:
      type: object
      required: [id, name, created_at]
      properties:
        id: { type: integer, format: int64 }
        name: { type: string }
        icon: { type: string, nullable: true }
        color:
          type: string
          nullable: true
          description: Optional hex color like #RRGGBB
          example: "#00AEEF"
        created_at: { type: string, format: date-time }

    AdminGameUploadResult:
      type: object
      required: [ game_id, object_key, etag, filename ]
      properties:
        game_id:
          type: integer
          format: int64
          example: 7
        object_key:
          type: string
          example: games/7/game.zip
          description: Object key stored in MinIO
        etag:
          type: string
          example: "a1b2c3d4e5f6"
          description: ETag returned by MinIO after upload
        filename:
          type: string
          example: my_game.zip

    AdminEducationCategoryListData:
      type: object
      required: [items, page, limit, total]
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/AdminEducationCategoryDTO" }
        page: { type: integer, example: 1 }
        limit: { type: integer, example: 24 }
        total: { type: integer, example: 5 }

    AdminEducationCategoryCreateRequest:
      type: object
      required: [name]
      properties:
        name: { type: string, minLength: 1, maxLength: 100 }
        icon: { type: string, nullable: true, maxLength: 100 }
        color:
          type: string
          nullable: true
          description: Optional hex color like #RRGGBB
          pattern: "^#([0-9a-fA-F]{6})$"

    AdminEducationCategoryUpdateRequest:
      type: object
      description: Partial update. Only provided fields are updated.
      properties:
        name: { type: string, minLength: 1, maxLength: 100 }
        icon: { type: string, nullable: true, maxLength: 100 }
        color:
          type: string
          nullable: true
          description: Optional hex color like #RRGGBB
          pattern: "^#([0-9a-fA-F]{6})$"

    AdminAgeCategoryDTO:
      type: object
      required: [id, label, min_age, max_age, created_at]
      properties:
        id: { type: integer, format: int64 }
        label: { type: string, example: "7+" }
        min_age: { type: integer, minimum: 0, example: 7 }
        max_age: { type: integer, minimum: 0, example: 10 }
        created_at: { type: string, format: date-time }

    AdminAgeCategoryListData:
      type: object
      required: [items, page, limit, total]
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/AdminAgeCategoryDTO" }
        page: { type: integer, example: 1 }
        limit: { type: integer, example: 24 }
        total: { type: integer, example: 4 }

    AdminAgeCategoryCreateRequest:
      type: object
      required: [label, min_age, max_age]
      properties:
        label: { type: string, minLength: 1, maxLength: 50, example: "7+" }
        min_age: { type: integer, minimum: 0, example: 7 }
        max_age: { type: integer, minimum: 0, example: 10 }

    AdminAgeCategoryUpdateRequest:
      type: object
      description: Partial update. Only provided fields are updated.
      properties:
        label: { type: string, minLength: 1, maxLength: 50, example: "7+" }
        min_age: { type: integer, minimum: 0, example: 7 }
        max_age: { type: integer, minimum: 0, example: 10 }

    AdminAchievementUpsertRequest:
      type: object
      required: [game_id, title]
      properties:
        game_id: { type: integer, format: int64 }
        title: { type: string }
        description: { type: string }
        rule:
          type: object
          description: "JSON rule definition (MVP: stored as JSON)"
          additionalProperties: true
        reward:
          type: object
          additionalProperties: true

    ModerationRemoveScoreRequest:
      type: object
      required: [game_id, member, period]
      properties:
        game_id: { type: integer, format: int64 }
        member:
          type: string
          description: Member key (e.g., p:123 or g:sess_abc)
        period:
          type: string
          enum: [daily, weekly]
        scope:
          type: string
          enum: [game, global]
          default: game

    AdminMe:
      type: object
      properties:
        id: { type: integer, format: int64 }
        email: { type: string, format: email }
        role: { type: string, example: admin }

    GameListItem:
      type: object
      properties:
        id: { type: integer, format: int64 }
        title: { type: string }
        slug: { type: string }
        thumbnail: { type: string, nullable: true }
        game_url: { type: string, nullable: true }
        age_category_id: { type: integer, format: int64 }
        free: { type: boolean }
        created_at: { type: string, format: date-time }
      required: [id, title, slug, age_category_id, free, created_at]

    GameListData:
      type: object
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/GameListItem" }
        page: { type: integer, example: 1 }
        limit: { type: integer, example: 24 }
        total: { type: integer, example: 1 }
      required: [items, page, limit, total]

    GameDetail:
      type: object
      properties:
        id: { type: integer, format: int64 }
        title: { type: string }
        slug: { type: string }
        thumbnail: { type: string, nullable: true }
        game_url:
          type: string
          nullable: true
          description: URL to load in iframe (served via Nginx/MinIO later)
        age_category_id: { type: integer, format: int64 }
        free: { type: boolean }
        created_at: { type: string, format: date-time }
      required: [id, title, slug, age_category_id, free, created_at]
