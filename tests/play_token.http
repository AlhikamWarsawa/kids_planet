#@baseUrl = http://localhost:8080/api
 @baseUrl = http://localhost/api

@json = application/json

### Health check
GET {{baseUrl}}/health
Accept: {{json}}

### start session (valid)
POST {{baseUrl}}/sessions/start
Accept: {{json}}
Content-Type: {{json}}

{
  "game_id": 1
}

> {%
    client.test("start session should return 200", function() {
        client.assert(response.status === 200, "Expected 200");
    });

    const body = response.body;
    client.test("response has data.play_token", function() {
        client.assert(!!body.data, "Missing data");
        client.assert(!!body.data.play_token, "Missing play_token");
    });

    client.global.set("play_token", body.data.play_token);
%}

### missing body (400)
POST {{baseUrl}}/sessions/start
Accept: {{json}}
Content-Type: {{json}}

> {%
    client.test("missing body should return 400", function() {
        client.assert(response.status === 400, "Expected 400");
    });
%}

### game_id string (400)
POST {{baseUrl}}/sessions/start
Accept: {{json}}
Content-Type: {{json}}

{
  "game_id": "abc"
}

> {%
    client.test("game_id string should return 400", function() {
        client.assert(response.status === 400, "Expected 400");
    });
%}

### game_id missing (400)
POST {{baseUrl}}/sessions/start
Accept: {{json}}
Content-Type: {{json}}

{
}

> {%
    client.test("missing game_id should return 400", function() {
        client.assert(response.status === 400, "Expected 400");
    });
%}

### game not found or not active (400)
POST {{baseUrl}}/sessions/start
Accept: {{json}}
Content-Type: {{json}}

{
  "game_id": 999999
}

> {%
    client.test("game not found/not active should return 400", function() {
        client.assert(response.status === 400, "Expected 400");
    });
%}

### Admin login to get admin access_token
POST {{baseUrl}}/auth/admin/login
Accept: {{json}}
Content-Type: {{json}}

{
  "email": "admin@kidsplanet.com",
  "password": "12345678"
}

> {%
    client.test("admin login should return 200", function() {
        client.assert(response.status === 200, "Expected 200");
    });

    const body = response.body;
    client.global.set("admin_token", body.data.access_token);
%}

### using admin JWT as play_token (401)
GET {{baseUrl}}/admin/ping
Accept: {{json}}
Authorization: Bearer {{play_token}}

> {%
    client.test("admin/ping with play_token should be 401/403 (protected by admin middleware)", function() {
        client.assert([401,403].includes(response.status), "Expected 401 or 403");
    });
%}

### token expired (401)

 @playProtectedUrl = {{baseUrl}}/leaderboard/submit
 POST {{playProtectedUrl}}
 Accept: {{json}}
 Content-Type: {{json}}
 Authorization: Bearer <PUT_EXPIRED_PLAY_TOKEN_HERE>

 {
   "game_id": 1,
   "score": 10
 }

 > {%
   client.test("expired play_token should return 401", function() {
     client.assert(response.status === 401, "Expected 401");
   });
 %}

### token valid but game mismatch (403)

 POST {{playProtectedUrl}}
 Accept: {{json}}
 Content-Type: {{json}}
 Authorization: Bearer {{play_token}}

 {
   "game_id": 2,
   "score": 10
 }

 > {%
   client.test("game_id mismatch should return 403", function() {
     client.assert(response.status === 403, "Expected 403");
   });
 %}